#cloud-config
hostname: homeautomation
manage_etc_hosts: true
packages:
- avahi-daemon
- net-tools
- iproute2
- raspi-config
- build-essential
- git
- curl
- wget
- unzip
apt:
  conf: |
    Acquire {
      Check-Date "false";
    };

# Goes in user-data
growpart:
  mode: off

package_update: true
package_upgrade: true

# Setup rpi as system user, default password is "changeme"
users:
- name: rpi
  groups: users,adm,dialout,audio,netdev,video,plugdev,cdrom,games,input,gpio,spi,i2c,render,sudo
  shell: /bin/bash
  lock_passwd: false
  passwd: $5$WROBDhsulN$lZgNU4Ab2ISyCUGQiYfoqZjH3ZnawDj2cXT1l7qYP.5

# Enable password authentication for SSH
ssh_pwauth: true


write_files:
- encoding: b64
  # content is base64-encoded ./cloud-init/homeautomation.sh
  content: IyEvYmluL2Jhc2gKc2V0IC1ldW8gcGlwZWZhaWwKCmV4cG9ydCBERUJJQU5fRlJPTlRFTkQ9bm9uaW50ZXJhY3RpdmUKCiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KIyBQYXJ0aXRpb24gYW5kIGZvcm1hdCB0aGUgcmVtYWluaW5nIGZyZWUgc3BhY2Ugb24gdGhlIGRpc2sKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQoKZWNobyAiPT09IFBhcnRpdGlvbmluZyBhbmQgZm9ybWF0dGluZyByZW1haW5pbmcgZnJlZSBzcGFjZSA9PT0iCgojIEdldCByb290IGRldmljZSAoZS5nLiwgL2Rldi9tbWNibGswcDIgb3IgL2Rldi9udm1lMG4xcDIpClJPT1RfUEFSVD0kKGZpbmRtbnQgLW4gLW8gU09VUkNFIC8pCgojIEV4dHJhY3QgZGlzayBmcm9tIHBhcnRpdGlvbiAod29ya3MgZm9yIHNkYTEsIG52bWUwbjFwMiwgbW1jYmxrMHAyKQppZiBbWyAiJFJPT1RfUEFSVCIgPX4gcFswLTldKyQgXV07IHRoZW4KCURJU0s9JChlY2hvICIkUk9PVF9QQVJUIiB8IHNlZCAtRSAncy9wWzAtOV0rJC8vJykKZWxzZQoJRElTSz0kKGVjaG8gIiRST09UX1BBUlQiIHwgc2VkIC1FICdzL1swLTldKyQvLycpCmZpCgojIFJlc2l6ZSByb290IHBhcnRpdGlvbiB0byAzMkdCCnBhcnRlZCAtLS1wcmV0ZW5kLWlucHV0LXR0eSAiJERJU0siIHJlc2l6ZXBhcnQgMiAzMkdpQiA8PDwgIlllcyIKcmVzaXplMmZzICIkUk9PVF9QQVJUIgoKZWNobyAiUm9vdCBmaWxlc3lzdGVtIGlzIG9uOiAkUk9PVF9QQVJUIgplY2hvICJEZXRlY3RlZCBkaXNrOiAkRElTSyIKCiMgRmluZCBzdGFydCBvZiBsYXN0IGZyZWUgc3BhY2UgYmxvY2sKRlJFRV9TVEFSVD0kKHBhcnRlZCAkRElTSyB1bml0IHMgcHJpbnQgZnJlZSB8IGdyZXAgJ0ZyZWUgU3BhY2UnIHwgdGFpbCAtbjEgfCBhd2sgJ3twcmludCAkMX0nKQoKaWYgWyAteiAiJEZSRUVfU1RBUlQiIF07IHRoZW4KCWVjaG8gIk5vIGZyZWUgc3BhY2UgZGV0ZWN0ZWQgb24gJERJU0suIFNraXBwaW5nIHBhcnRpdGlvbmluZy4iCmVsc2UKCWVjaG8gIkNyZWF0aW5nIHBhcnRpdGlvbiBmcm9tIHNlY3RvciAke0ZSRUVfU1RBUlR9IHRvIDEwMCUuLi4iCgoJcGFydGVkIC1zICIkRElTSyIgbWtwYXJ0IHByaW1hcnkgZXh0NCAiJHtGUkVFX1NUQVJUfSIgMTAwJQoKCXBhcnRwcm9iZSAiJERJU0siCglzbGVlcCAyCgoJIyBHZXQgbGFzdCBwYXJ0aXRpb24gbmFtZQoJTkVXX1BBUlQ9JChsc2JsayAtbG4gLW8gTkFNRSAiJERJU0siIHwgdGFpbCAtbjEpCglORVdfUEFSVD0iL2Rldi8kTkVXX1BBUlQiCgoJZWNobyAiRm9ybWF0dGluZyAkTkVXX1BBUlQuLi4iCgoJbWtmcy5leHQ0IC1GIC1MIGRhdGEgIiRORVdfUEFSVCIKCgllY2hvICJEb25lLiBDcmVhdGVkIGFuZCBmb3JtYXR0ZWQ6ICRORVdfUEFSVCIKCiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KIyBNaWdyYXRlIC9ob21lL3JwaSB0byB0aGUgbmV3IHBhcnRpdGlvbgojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CgoJZWNobyAiPT09IE1pZ3JhdGluZyAvaG9tZS9ycGkgdG8gbmV3IHBhcnRpdGlvbiA9PT0iCgoJVE1QX01PVU5UPSIvbW50L25ld19ob21lIgoJRklOQUxfTU9VTlQ9Ii9ob21lL3JwaSIKCgllY2hvICJQcmVwYXJpbmcgbWlncmF0aW9uIG9mICRGSU5BTF9NT1VOVC4uLiIKCglta2RpciAtcCAiJFRNUF9NT1VOVCIKCgllY2hvICJUZW1wb3JhcmlseSBtb3VudGluZyAkTkVXX1BBUlQuLi4iCgltb3VudCAiJE5FV19QQVJUIiAiJFRNUF9NT1VOVCIKCgllY2hvICJDb3B5aW5nIGV4aXN0aW5nIGRhdGEuLi4iCglyc3luYyAtYUFYICIkRklOQUxfTU9VTlQiLyAiJFRNUF9NT1VOVCIvCgoJZWNobyAiVXBkYXRpbmcgL2V0Yy9mc3RhYi4uLiIKCWNwIC9ldGMvZnN0YWIgL2V0Yy9mc3RhYi5iYWNrdXAKCWVjaG8gIkxBQkVMPWRhdGEJL2hvbWUvcnBpCWV4dDQJZGVmYXVsdHMsbm9hdGltZQkwCTIiID4+IC9ldGMvZnN0YWIKCgllY2hvICJVbm1vdW50aW5nIHRlbXBvcmFyeSBtb3VudC4uLiIKCXVtb3VudCAiJFRNUF9NT1VOVCIKCgllY2hvICJNb3VudGluZyBuZXcgL2hvbWUvcnBpLi4uIgoJbW91bnQgIiRGSU5BTF9NT1VOVCIKCgllY2hvICJNaWdyYXRpb24gY29tcGxldGUuIgpmaQoKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQojIERvY2tlciBpbnN0YWxsYXRpb24KIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQoKZWNobyAiPT09IFVwZGF0ZSBhcHQgY2FjaGUgYW5kIGluc3RhbGwgcHJlcmVxdWlzaXRlcyA9PT0iCmFwdC1nZXQgdXBkYXRlCmFwdC1nZXQgaW5zdGFsbCAteSBjYS1jZXJ0aWZpY2F0ZXMgY3VybAppbnN0YWxsIC1tIDA3NTUgLWQgL2V0Yy9hcHQva2V5cmluZ3MKY3VybCAtZnNTTCBodHRwczovL2Rvd25sb2FkLmRvY2tlci5jb20vbGludXgvdWJ1bnR1L2dwZyAtbyAvZXRjL2FwdC9rZXlyaW5ncy9kb2NrZXIuYXNjCmNobW9kIGErciAvZXRjL2FwdC9rZXlyaW5ncy9kb2NrZXIuYXNjCgplY2hvICI9PT0gQWRkIGRvY2tlciByZXBvc2l0b3J5IHRvIGFwdCBzb3VyY2VzID09PSIKdGVlIC9ldGMvYXB0L3NvdXJjZXMubGlzdC5kL2RvY2tlci5zb3VyY2VzIDw8RU9GClR5cGVzOiBkZWIKVVJJczogaHR0cHM6Ly9kb3dubG9hZC5kb2NrZXIuY29tL2xpbnV4L3VidW50dQpTdWl0ZXM6ICQoLiAvZXRjL29zLXJlbGVhc2UgJiYgZWNobyAiJHtVQlVOVFVfQ09ERU5BTUU6LSRWRVJTSU9OX0NPREVOQU1FfSIpCkNvbXBvbmVudHM6IHN0YWJsZQpTaWduZWQtQnk6IC9ldGMvYXB0L2tleXJpbmdzL2RvY2tlci5hc2MKRU9GCgplY2hvICI9PT0gVXBhZGUgc3lzdGVtIHdpdGggdGhlIHBhY2thZ2UgbGlzdCBmcm9tIGRvY2tlciByZXBvc2l0b3J5ID09PSIKYXB0LWdldCB1cGRhdGUKCmVjaG8gIj09PSBJbnN0YWxsIGRvY2tlciBwYWNrYWdlcyA9PT0iCmFwdC1nZXQgaW5zdGFsbCAteSBkb2NrZXItY2UgZG9ja2VyLWNlLWNsaSBjb250YWluZXJkLmlvIGRvY2tlci1idWlsZHgtcGx1Z2luIGRvY2tlci1jb21wb3NlLXBsdWdpbgoKZWNobyAiPT09IEFkZCBycGkgdXNlciB0byB0aGUgZG9ja2VyIGdyb3VwIHRvIGdyYW50IGFsbCB0aGUgcGVybWlzc2lvbnMgcmVsYXRlZCB0byBkb2NrZXIgPT09Igp1c2VybW9kIC1hRyBkb2NrZXIgcnBpCgpzeXN0ZW1jdGwgZW5hYmxlIGRvY2tlcgpzeXN0ZW1jdGwgc3RhcnQgZG9ja2VyCgojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiMgQ29uZmlndXJlIFBDSSBFeHByZXNzIDMsIDEtV2lyZSBhbmQgQ0FOIGluIGNvbmZpZy50eHQKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQplY2hvICI9PT0gQ29uZmlndXJpbmcgUENJIEV4cHJlc3MgMywgMS1XaXJlIGFuZCBDQU4gaW4gY29uZmlnLnR4dCA9PT0iCnN1ZG8gdGVlIC1hICIvYm9vdC9maXJtd2FyZS9jb25maWcudHh0IiA+IC9kZXYvbnVsbCA8PCAnRU9GJwojIEVuYWJsZSBQQ0kgRXhwcmVzcyAzCmR0cGFyYW09cGNpZXgxCmR0cGFyYW09cGNpZXgxX2dlbj0zCgojIEVuYWJsZSAxLVdpcmUgY29tbXVuaWNhdGlvbgpkdG92ZXJsYXk9dzEtZ3BpbwoKIyBFbmFibGUgQ0FOIGNvbW11bmljYXRpb24KZHRvdmVybGF5PWkyYzAKZHRvdmVybGF5PXNwaTEtM2NzCmR0b3ZlcmxheT1tY3AyNTE1LHNwaTEtMixvc2NpbGxhdG9yPTE2MDAwMDAwLGludGVycnVwdD0xMwpkdG92ZXJsYXk9bWNwMjUxNSxzcGkxLTEsb3NjaWxsYXRvcj0xNjAwMDAwMCxpbnRlcnJ1cHQ9MjIKRU9GCgojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiMgUmFzcGJlcnJ5IFBpIDItQ0ggQ0FOIEhBVCBzZXR1cAojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CgplY2hvICI9PT0gSW5zdGFsbGluZyBjYW4tdXRpbHMgPT09IgphcHQtZ2V0IGluc3RhbGwgY2FuLXV0aWxzCgplY2hvICI9PT0gQ3JlYXRpbmcgc3lzdGVtZCBzZXJ2aWNlIGZvciBjYW4wID09PSIKY2F0IDw8ICdFT0YnID4gL2V0Yy9zeXN0ZW1kL3N5c3RlbS9jYW4wLnNlcnZpY2UKW1VuaXRdCkRlc2NyaXB0aW9uPVNldCB1cCBjYW4wIGludGVyZmFjZQpSZXF1aXJlcz1uZXR3b3JrLnRhcmdldApBZnRlcj1uZXR3b3JrLnRhcmdldAoKW1NlcnZpY2VdClR5cGU9b25lc2hvdApFeGVjU3RhcnQ9L3NiaW4vaXAgbGluayBzZXQgY2FuMCB1cCB0eXBlIGNhbiBiaXRyYXRlIDUwMDAwMCByZXN0YXJ0LW1zIDEwMApFeGVjU3RhcnRQb3N0PS9zYmluL2lwIGxpbmsgc2V0IGNhbjAgdHhxdWV1ZWxlbiA2NTUzNgpFeGVjU3RvcD0vc2Jpbi9pcCBsaW5rIHNldCBjYW4wIGRvd24KUmVtYWluQWZ0ZXJFeGl0PXllcwoKW0luc3RhbGxdCldhbnRlZEJ5PW11bHRpLXVzZXIudGFyZ2V0CkVPRgoKZWNobyAiPT09IENyZWF0aW5nIHN5c3RlbWQgc2VydmljZSBmb3IgY2FuMSA9PT0iCmNhdCA8PCAnRU9GJyA+IC9ldGMvc3lzdGVtZC9zeXN0ZW0vY2FuMS5zZXJ2aWNlCltVbml0XQpEZXNjcmlwdGlvbj1TZXQgdXAgY2FuMSBpbnRlcmZhY2UKUmVxdWlyZXM9bmV0d29yay50YXJnZXQKQWZ0ZXI9bmV0d29yay50YXJnZXQKCltTZXJ2aWNlXQpUeXBlPW9uZXNob3QKRXhlY1N0YXJ0PS9zYmluL2lwIGxpbmsgc2V0IGNhbjEgdXAgdHlwZSBjYW4gYml0cmF0ZSA1MDAwMDAgcmVzdGFydC1tcyAxMDAKRXhlY1N0YXJ0UG9zdD0vc2Jpbi9pcCBsaW5rIHNldCBjYW4xIHR4cXVldWVsZW4gNjU1MzYKRXhlY1N0b3A9L3NiaW4vaXAgbGluayBzZXQgY2FuMSBkb3duClJlbWFpbkFmdGVyRXhpdD15ZXMKCltJbnN0YWxsXQpXYW50ZWRCeT1tdWx0aS11c2VyLnRhcmdldApFT0YKCmVjaG8gIj09PSBFbmFibGluZyBDQU4gc2VydmljZXMgPT09IgpzeXN0ZW1jdGwgZGFlbW9uLXJlbG9hZApzeXN0ZW1jdGwgZW5hYmxlIGNhbjAuc2VydmljZQpzeXN0ZW1jdGwgZW5hYmxlIGNhbjEuc2VydmljZQpzeXN0ZW1jdGwgc3RhcnQgY2FuMC5zZXJ2aWNlIHx8IGVjaG8gImNhbjAgaXMgbm90IGF2YWlsYWJsZSB5ZXQiCnN5c3RlbWN0bCBzdGFydCBjYW4xLnNlcnZpY2UgfHwgZWNobyAiY2FuMSBpcyBub3QgYXZhaWxhYmxlIHlldCIKCiM9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0iCiMgSW5zdGFsbCBob21lIGF1dG9tYXRpb24gYWdlbnQKIz09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSIKCmVjaG8gIj09PSBJbnN0YWxsIEhvbWUgQXV0b21hdGlvbiBBZ2VudCA9PT0iCgpjdXJsIC1mTCAtTyBodHRwczovL2dpdGh1Yi5jb20vbmVqY29rb3JuL2hvbWUtYXV0b21hdGlvbi1hZ2VudC9yZWxlYXNlcy9kb3dubG9hZC92MS4yLjAvaG9tZS1hdXRvbWF0aW9uLWFnZW50XzEuMi4wX2FybTY0LmRlYgoKIyBJbnN0YWxsIGhvbWUtYXV0b21hdGlvbi1hZ2VudF8xLjIuMF9hcm02NC5kZWIKZHBrZyAtaSBob21lLWF1dG9tYXRpb24tYWdlbnRfMS4yLjBfYXJtNjQuZGViCgojIEZpeCBicm9rZW4gZGVwZW5kZW5jaWVzIGlmIGFueQphcHQtZ2V0IC1mIGluc3RhbGwgLXkKCnN5c3RlbWN0bCBkYWVtb24tcmVsb2FkCnN5c3RlbWN0bCBlbmFibGUgLS1ub3cgaG9tZS1hdXRvbWF0aW9uLWFnZW50CgojPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IgojIEluc3RhbGwgVlMgQ29kZSBTZXJ2ZXIKIz09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSIKCmVjaG8gIj09PSBJbnN0YWxsaW5nIFZTIENvZGUgU2VydmVyID09PSIKCmV4cG9ydCBIT01FPS9ob21lL3JwaQpleHBvcnQgVVNFUj1ycGkKY3VybCAtZnNTTCBodHRwczovL2NvZGUtc2VydmVyLmRldi9pbnN0YWxsLnNoIHwgc2gKCiMgQ3JlYXRlIGNvbmZpZy55YW1sIGZvciBjb2RlLXNlcnZlciB3aXRoIHBhc3N3b3JkIGF1dGhlbnRpY2F0aW9uIGFuZCBubyBUTFMKZWNobyAiPT09IENyZWF0aW5nIGNvZGUtc2VydmVyIGNvbmZpZyBmaWxlID09PSIKCiMgY3JlYXRlIGNvbmZpZyBkaXJlY3RvcnkgaWYgaXQgZG9lc24ndCBleGlzdCBhbmQgc2V0IG93bmVyc2hpcCB0byBycGkKbWtkaXIgLXAgL2hvbWUvcnBpLy5jb25maWcvY29kZS1zZXJ2ZXIKY2htb2QgNzU1IC9ob21lL3JwaS8uY29uZmlnCmNobW9kIDc1NSAvaG9tZS9ycGkvLmNvbmZpZy9jb2RlLXNlcnZlcgpjaG93biAtUiBycGk6cnBpIC9ob21lL3JwaS8uY29uZmlnCgpjYXQgPDxFT0YgPiAiL2hvbWUvcnBpLy5jb25maWcvY29kZS1zZXJ2ZXIvY29uZmlnLnlhbWwiCmJpbmQtYWRkcjogMC4wLjAuMDo4MDgwCmF1dGg6IHBhc3N3b3JkCnBhc3N3b3JkOiBjaGFuZ2VtZQpjZXJ0OiBmYWxzZQpFT0YKCiMgRW5hYmxlIGFuZCBzdGFydCBjb2RlLXNlcnZlciBmb3IgdGhlIHJwaSB1c2VyCmVjaG8gIj09PSBFbmFibGluZyBhbmQgc3RhcnRpbmcgY29kZS1zZXJ2ZXIgZm9yIHJwaSB1c2VyID09PSIKc3lzdGVtY3RsIGVuYWJsZSAtLW5vdyBjb2RlLXNlcnZlckBycGkKCiM9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0iCiMgU2V0dXAgaG9tZSBhdXRvbWF0aW9uIHN0YWNrCiM9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0iCgplY2hvICI9PT0gU2V0dXAgaG9tZSBhdXRvbWF0aW9uIHN0YWNrID09PSIKCm1rZGlyIC1wIC9ob21lL3JwaQpjZCAvaG9tZS9ycGkKZ2l0IGNsb25lIGh0dHBzOi8vZ2l0aHViLmNvbS9uZWpjb2tvcm4vaG9tZS1hdXRvbWF0aW9uLmdpdApjaG93biBycGk6cnBpIC9ob21lL3JwaSAtUgpjZCAvaG9tZS9ycGkvaG9tZS1hdXRvbWF0aW9uCnN1ZG8gLXUgcnBpIGJhc2ggLWMgJ2NkIC9ob21lL3JwaS9ob21lLWF1dG9tYXRpb24gJiYgLi9zY3JpcHRzL2NvbmZpZ3VyZS5zaCcKc3VkbyAtdSBycGkgYmFzaCAtYyAnY2QgL2hvbWUvcnBpL2hvbWUtYXV0b21hdGlvbiAmJiBkb2NrZXIgY29tcG9zZSB1cCAtZCcKCmVjaG8gIj09PSBJbnN0YWxsIEhBQ1MgaW4gSG9tZSBBc3Npc3RhbnQgPT09IgpzdWRvIC11IHJwaSBiYXNoIDw8J0VPRicKIyBXYWl0IGZvciBIb21lIEFzc2lzdGFudCB0byBpbml0aWFsaXplIGl0cyBjb25maWcgZGlyZWN0b3J5Lgpmb3IgaSBpbiB7MS4uNjB9OyBkbwoJaWYgZG9ja2VyIGV4ZWMgaG9tZWFzc2lzdGFudCBiYXNoIC1jICd0ZXN0IC1mIC9jb25maWcvY29uZmlndXJhdGlvbi55YW1sJzsgdGhlbgoJCWJyZWFrCglmaQoJc2xlZXAgNQpkb25lCiMgSW5zdGFsbCBIQUNTIGluIEhvbWUgQXNzaXN0YW50CmRvY2tlciBleGVjIGhvbWVhc3Npc3RhbnQgYmFzaCAtYyAnCgljZCAvY29uZmlnCgljdXJsIC00IC1mc1NMIGh0dHBzOi8vZ2V0LmhhY3MueHl6IHwgYmFzaCAtCicKRU9GCgplY2hvICI9PT0gSW5zdGFsbCBOb2RlLVJFRCBwYWNrYWdlcyA9PT0iCnN1ZG8gLXUgcnBpIGJhc2ggPDwnRU9GJwpkb2NrZXIgZXhlYyBub2RlcmVkIGJhc2ggLWMgJwoJY2QgL2RhdGEKCW5wbSBpbnN0YWxsIEBob21lLWF1dG9tYXRpb24vaG9tZS1hdXRvbWF0aW9uLW1haW4KCW5wbSBpbnN0YWxsIG5vZGUtcmVkLWNvbnRyaWItc3VuLXBvc2l0aW9uCglucG0gaW5zdGFsbCBub2RlLXJlZC1jb250cmliLWhvbWUtYXNzaXN0YW50LXdlYnNvY2tldAonCkVPRgoKZWNobyAiPT09IFJlc3RhcnRpbmcgZG9ja2VyIHNlcnZpY2VzID09PSIKc3VkbyAtdSBycGkgYmFzaCA8PCdFT0YnCmNkIC9ob21lL3JwaS9ob21lLWF1dG9tYXRpb24KZG9ja2VyIGNvbXBvc2UgcmVzdGFydCBub2RlcmVkCmRvY2tlciBjb21wb3NlIHJlc3RhcnQgaG9tZWFzc2lzdGFudApFT0YK
  owner: root:root
  path: /usr/local/bin/homeautomation.sh
  permissions: '0755'

runcmd:
- [ bash, /usr/local/bin/homeautomation.sh ]

power_state:
  mode: reboot
  timeout: 30
  condition: true
